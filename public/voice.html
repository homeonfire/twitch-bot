<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ Twitch (Debug)</title>
    <style>
        body { background: #18181b; color: white; font-family: sans-serif; padding: 20px; text-align: center; }
        #status { font-size: 24px; font-weight: bold; color: #4caf50; margin-bottom: 20px; }
        /* –ö—Ä–∞—Å–∏–≤–æ–µ –æ–∫–æ—à–∫–æ –¥–ª—è –ª–æ–≥–æ–≤ –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
        #log-container { background: #000; color: #0f0; font-family: monospace; font-size: 14px; text-align: left; padding: 15px; border-radius: 8px; height: 400px; overflow-y: auto; white-space: pre-wrap; margin-top: 20px; border: 1px solid #333;}
    </style>
</head>
<body>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>
    <div id="log-container">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...<br></div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log-container');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤ –∏ –≤ –∫–æ–Ω—Å–æ–ª—å (F12), –∏ –Ω–∞ —ç–∫—Ä–∞–Ω
        function debugLog(message, data = '') {
            const time = new Date().toLocaleTimeString();
            const logText = `[${time}] ${message} ${typeof data === 'object' ? JSON.stringify(data) : data}`;
            console.log(logText);
            logEl.innerHTML = logText + "<br>" + logEl.innerHTML; // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—Ä—Ö—É
        }

        const urlParams = new URLSearchParams(window.location.search);
        const currentChannel = urlParams.get('channel');
        let wakeWord = "–±–æ—Ç"; 

        debugLog("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è. –ö–∞–Ω–∞–ª –∏–∑ URL:", currentChannel);

        if (!currentChannel) {
            statusEl.innerText = "–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –∫–∞–Ω–∞–ª!";
            statusEl.style.color = "red";
            debugLog("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í —Å—Å—ã–ª–∫–µ –Ω–µ—Ç ?channel=–¢–í–û–ô_–ö–ê–ù–ê–õ");
        } else {
            debugLog("üåê –°—Ç—É—á–∏–º—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–∞–Ω–∞–ª–∞...");
            fetch(`/api/voice/${currentChannel}/settings`)
                .then(res => {
                    debugLog("üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Å—Ç–∞—Ç—É—Å):", res.status);
                    return res.json();
                })
                .then(data => {
                    debugLog("üì¶ –ü–æ–ª—É—á–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ë–î:", data);
                    if (data.wake_word) {
                        wakeWord = data.wake_word.toLowerCase().trim();
                        debugLog(`‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ: "${wakeWord}"`);
                        statusEl.innerText = `–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω. –°–∫–∞–∂–∏: "${wakeWord} ..."`;
                        startListening();
                    } else {
                        statusEl.innerText = "–û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!";
                        statusEl.style.color = "red";
                        debugLog("‚ùå –û–®–ò–ë–ö–ê: –ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω.");
                    }
                })
                .catch(err => debugLog("‚ùå –û–®–ò–ë–ö–ê —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:", err));
        }

        function startListening() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                statusEl.innerText = "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.";
                debugLog("‚ùå –û–®–ò–ë–ö–ê: –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition (–Ω—É–∂–µ–Ω Chrome/Edge).");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = true; 
            recognition.interimResults = false;

            recognition.onstart = function() {
                debugLog("üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, —Å–ª—É—à–∞—é...");
            };

            recognition.onresult = function(event) {
                const rawTranscript = event.results[event.results.length - 1][0].transcript;
                const transcript = rawTranscript.toLowerCase().trim();
                
                debugLog(`üó£Ô∏è –£–°–õ–´–®–ê–õ: "${transcript}"`);

                if (transcript.startsWith(wakeWord)) {
                    debugLog("‚úÖ –ö–û–î–û–í–û–ï –°–õ–û–í–û –°–û–í–ü–ê–õ–û!");
                    statusEl.innerText = "–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å...";
                    statusEl.style.color = "#ffeb3b";
                    
                    const question = transcript.substring(wakeWord.length).trim();
                    debugLog(`‚ùì –í–æ–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: "${question}"`);

                    fetch(`/api/voice/${currentChannel}/ask`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ text: question })
                    })
                    .then(res => {
                        debugLog(`üì° –û—Ç–≤–µ—Ç –æ—Ç DeepSeek (HTTP ${res.status})`);
                        return res.json();
                    })
                    .then(data => {
                        debugLog("üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
                        statusEl.innerText = `–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω. –°–∫–∞–∂–∏: "${wakeWord} ..."`;
                        statusEl.style.color = "#4caf50";
                    })
                    .catch(err => {
                        debugLog("‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ —Å–µ—Ä–≤–µ—Ä—É/DeepSeek:", err);
                        statusEl.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!";
                        statusEl.style.color = "red";
                    });
                } else {
                    debugLog("‚ö†Ô∏è –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò–≥–Ω–æ—Ä–∏—Ä—É—é.");
                }
            };

            recognition.onerror = function(event) {
                debugLog("‚ùå –û–®–ò–ë–ö–ê –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:", event.error);
            };

            recognition.onend = function() {
                debugLog("üîÑ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–∏–ª—Å—è. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é...");
                setTimeout(() => recognition.start(), 1000);
            };

            try {
                recognition.start();
            } catch(e) {
                debugLog("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:", e);
            }
        }
    </script>
</body>
</html>