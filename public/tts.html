<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TTS Player</title>
</head>
<body>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const currentChannel = urlParams.get('channel');

        function fallbackSpeech(text, callback) {
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'ru-RU';
            utterThis.rate = 1.1; 
            
            utterThis.onend = function() {
                setTimeout(callback, 1000);
            };
            
            utterThis.onerror = function() {
                setTimeout(callback, 1000);
            };

            window.speechSynthesis.speak(utterThis);
        }

        function pollTts() {
            if (!currentChannel) return;

            // üöÄ –ò–°–ü–†–ê–í–õ–ï–ù–ê –°–°–´–õ–ö–ê: —Ç–µ–ø–µ—Ä—å —Å—Ç—É—á–∏–º—Å—è –Ω–∞ /next
            fetch(`/api/tts/${currentChannel}/next`)
                .then(res => {
                    // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 404 –∏–ª–∏ 500), –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è —á–∏—Ç–∞—Ç—å —ç—Ç–æ –∫–∞–∫ JSON
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ (–º—ã –∑–∞–¥–∞–ª–∏ status: 'success' –∏–ª–∏ 'empty' –≤ API)
                    if (data.status === 'success' && data.message) {
                        
                        /// 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫—Ä—É—Ç–æ–π –∑–≤—É–∫ –æ—Ç ElevenLabs
                        if (data.audio_base64) {
                            console.log("üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É –∫—Ä—É—Ç–æ–π –≥–æ–ª–æ—Å ElevenLabs...");
                            const audio = new Audio(data.audio_base64);
                            audio.onended = () => setTimeout(pollTts, 1000);
                            audio.play().catch(e => {
                                console.error("–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ:", e);
                                fallbackSpeech(data.message, pollTts);
                            });
                            
                        // üöÄ 2. –ï—Å–ª–∏ ElevenLabs –Ω–µ—Ç, –Ω–æ —Å–µ—Ä–≤–µ—Ä –¥–∞–ª —Å—Å—ã–ª–∫—É –Ω–∞ Google Translate
                        } else if (data.audio_url) {
                            console.log("üåê –í–∫–ª—é—á–∞—é –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ Google-—Ä–æ–±–æ—Ç–∞...");
                            const audio = new Audio(data.audio_url);
                            audio.onended = () => setTimeout(pollTts, 1000);
                            audio.play().catch(e => {
                                console.error("Google TTS –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –≤–∫–ª—é—á–∞—é –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Ä–æ–±–æ—Ç–∞:", e);
                                fallbackSpeech(data.message, pollTts);
                            });

                        // 3. –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –≤—Å—ë —Å–ª–æ–º–∞–ª–æ—Å—å ‚Äî —á–∏—Ç–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–æ–º
                        } else {
                            console.log("ü§ñ –ß–∏—Ç–∞—é –æ–±—ã—á–Ω—ã–º –≥–æ–ª–æ—Å–æ–º Windows/macOS...");
                            fallbackSpeech(data.message, pollTts);
                        }
                    } else {
                        // –°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, —Å—Ç–∞—Ç—É—Å 'empty', –∂–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(pollTts, 2000);
                    }
                })
                .catch(err => {
                    console.error("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", err);
                    setTimeout(pollTts, 5000);
                });
        }

        pollTts();
    </script>
</body>
</html>