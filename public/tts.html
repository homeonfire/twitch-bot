<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TTS Player</title>
</head>
<body>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const currentChannel = urlParams.get('channel');

        function fallbackSpeech(text, callback) {
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'ru-RU';
            utterThis.rate = 1.1; 
            
            utterThis.onend = function() {
                setTimeout(callback, 1000);
            };
            
            utterThis.onerror = function() {
                setTimeout(callback, 1000);
            };

            window.speechSynthesis.speak(utterThis);
        }

        function pollTts() {
            if (!currentChannel) return;

            // üöÄ –ò–°–ü–†–ê–í–õ–ï–ù–ê –°–°–´–õ–ö–ê: —Ç–µ–ø–µ—Ä—å —Å—Ç—É—á–∏–º—Å—è –Ω–∞ /next
            fetch(`/api/tts/${currentChannel}/next`)
                .then(res => {
                    // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 404 –∏–ª–∏ 500), –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è —á–∏—Ç–∞—Ç—å —ç—Ç–æ –∫–∞–∫ JSON
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ (–º—ã –∑–∞–¥–∞–ª–∏ status: 'success' –∏–ª–∏ 'empty' –≤ API)
                    if (data.status === 'success' && data.message) {
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–≤—É–∫ –æ—Ç ElevenLabs
                        if (data.audio_base64) {
                            console.log("üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É –∫—Ä—É—Ç–æ–π –≥–æ–ª–æ—Å ElevenLabs...");
                            const audio = new Audio(data.audio_base64);
                            
                            audio.onended = () => {
                                setTimeout(pollTts, 1000);
                            };
                            
                            audio.play().catch(e => {
                                console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –ø—Ä–∞–≤), –≤–∫–ª—é—á–∞—é —Ä–æ–±–æ—Ç–∞:", e);
                                fallbackSpeech(data.message, pollTts);
                            });
                        } else {
                            // –ï—Å–ª–∏ –∞—É–¥–∏–æ –Ω–µ—Ç (ElevenLabs –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤)
                            console.log("ü§ñ –¢–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç, —á–∏—Ç–∞—é –æ–±—ã—á–Ω—ã–º –≥–æ–ª–æ—Å–æ–º Windows/macOS...");
                            fallbackSpeech(data.message, pollTts);
                        }
                    } else {
                        // –°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, —Å—Ç–∞—Ç—É—Å 'empty', –∂–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(pollTts, 2000);
                    }
                })
                .catch(err => {
                    console.error("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", err);
                    setTimeout(pollTts, 5000);
                });
        }

        pollTts();
    </script>
</body>
</html>