<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TTS Player</title>
</head>
<body>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const currentChannel = urlParams.get('channel');

        function fallbackSpeech(text, callback) {
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'ru-RU';
            utterThis.rate = 1.1; // Чуть быстрее обычного
            
            utterThis.onend = function() {
                setTimeout(callback, 1000); // Ждем секунду и проверяем дальше
            };
            
            utterThis.onerror = function() {
                setTimeout(callback, 1000);
            };

            window.speechSynthesis.speak(utterThis);
        }

        function pollTts() {
            if (!currentChannel) return;

            fetch(`/api/tts/${currentChannel}/pop`)
                .then(res => res.json())
                .then(data => {
                    if (data.text) {
                        // Если сервер прислал нам сгенерированное аудио от ElevenLabs
                        if (data.audio_base64) {
                            console.log("Воспроизвожу ElevenLabs MP3...");
                            const audio = new Audio(data.audio_base64);
                            
                            audio.onended = () => {
                                setTimeout(pollTts, 1000);
                            };
                            
                            // Если браузер заблокировал автовоспроизведение
                            audio.play().catch(e => {
                                console.error("Ошибка воспроизведения аудио, включаю фоллбэк:", e);
                                fallbackSpeech(data.text, pollTts);
                            });
                        } else {
                            // Если токенов нет или API не настроен - старый добрый робот
                            console.log("Токенов нет, читаю обычным голосом...");
                            fallbackSpeech(data.text, pollTts);
                        }
                    } else {
                        // Очередь пуста, проверяем через 2 секунды
                        setTimeout(pollTts, 2000);
                    }
                })
                .catch(err => {
                    console.error("Ошибка связи с сервером:", err);
                    setTimeout(pollTts, 5000);
                });
        }

        // Запускаем бесконечный цикл проверок
        pollTts();
    </script>
</body>
</html>